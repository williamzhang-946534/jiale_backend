generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String                 @id @default(cuid())
  phone             String                 @unique
  nickname          String?
  password          String
  avatarUrl         String?
  role              UserRole               @default(CUSTOMER)
  level             Int                    @default(1)
  points            Int                    @default(0)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  walletBalance     Decimal                @default(0.0) @db.Decimal(18, 2)
  addresses         Address[]
  orders            Order[]                @relation("UserOrders")
  providers         Provider[]
  transactions      Transaction[]
  coupons           UserCoupon[]
  favoriteProviders UserFavoriteProvider[]
}

model Provider {
  id                  String                 @id @default(cuid())
  userId              String
  name                String
  phone               String
  status              ProviderStatus         @default(UNVERIFIED)
  intro               String?
  avatarUrl           String?
  idCardNumber        String?
  idCardImageUrl      String?
  certFiles           Json?
  rating              Decimal?               @db.Decimal(3, 2)
  todayEarnings       Decimal                @default(0.0) @db.Decimal(18, 2)
  walletBalance       Decimal                @default(0.0) @db.Decimal(18, 2)
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  isBanned            Boolean                @default(false)
  rejectReason        String?
  actualSalary        Decimal?               @db.Decimal(10, 2)
  age                 Int?
  chineseZodiac       String?
  expectedSalary      Decimal?               @db.Decimal(10, 2)
  experience          Int?
  homeAddress         String?
  hometown            String?
  isOnline            Boolean                @default(false)
  isRecommended       Boolean                @default(false)
  providerTypes       ProviderType[]
  serviceArea         String                 @default("河南漯河")
  totalOrders         Int                    @default(0)
  totalRevenue        Decimal                @default(0.0) @db.Decimal(18, 2)
  withdrawableBalance Decimal                @default(0.0) @db.Decimal(18, 2)
  workExperience      Json?
  zodiac              String?
  orders              Order[]                @relation("ProviderOrders")
  user                User                   @relation(fields: [userId], references: [id])
  dailyStats          ProviderDailyStats[]
  schedules           ProviderSchedule[]
  transactions        Transaction[]
  favoritedBy         UserFavoriteProvider[]
  withdrawals         Withdrawal[]
}

model ProviderDailyStats {
  id          String   @id @default(cuid())
  providerId  String
  date        DateTime @default(now()) @db.Date
  orderCount  Int      @default(0)
  orderAmount Decimal  @default(0.0) @db.Decimal(18, 2)
  orderTypes  Json?
  earnings    Decimal  @default(0.0) @db.Decimal(18, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  provider    Provider @relation(fields: [providerId], references: [id])

  @@unique([providerId, date])
}

model AdminUser {
  id        String     @id @default(cuid())
  username  String     @unique
  password  String
  name      String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  auditLogs AuditLog[]
}

model ServiceCategory {
  id        String            @id @default(cuid())
  name      String
  parentId  String?
  icon      String?
  sortOrder Int               @default(1)
  services  Service[]
  parent    ServiceCategory?  @relation("CategoryToParent", fields: [parentId], references: [id])
  children  ServiceCategory[] @relation("CategoryToParent")
}

model Service {
  id             String                 @id @default(cuid())
  name           String
  categoryId     String
  price          Decimal                @db.Decimal(18, 2)
  unit           String
  images         String[]
  description    String?
  tags           String[]
  status         String                 @default("active")
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  flashSales     FlashSale[]
  orders         Order[]
  category       ServiceCategory        @relation(fields: [categoryId], references: [id])
  specifications ServiceSpecification[]
}

model Address {
  id          String   @id @default(cuid())
  userId      String
  contactName String
  phone       String
  province    String
  city        String
  district    String
  detail      String
  fullAddress String?  // 完整地址字符串
  postalCode  String?  // 邮政编码
  tag         String?  // 地址标签
  latitude    Float?
  longitude   Float?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id])
  orders      Order[]
}

model Order {
  id              String              @id @default(cuid())
  orderNo         String              @unique
  userId          String
  providerId      String?
  serviceId       String
  addressId       String
  status          OrderStatus         @default(PENDING)
  serviceDate     DateTime
  serviceTime     String
  duration        Int?
  originalPrice   Decimal             @db.Decimal(18, 2)
  discount        Decimal             @db.Decimal(18, 2)
  totalPrice      Decimal             @db.Decimal(18, 2)
  paidAmount      Decimal             @default(0.0) @db.Decimal(18, 2)
  paidAt          DateTime?
  specialRequests String?
  timeline        Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  address         Address             @relation(fields: [addressId], references: [id])
  provider        Provider?           @relation("ProviderOrders", fields: [providerId], references: [id])
  service         Service             @relation(fields: [serviceId], references: [id])
  user            User                @relation("UserOrders", fields: [userId], references: [id])
  orderLogs       OrderOperationLog[]
  reviews         OrderReview?
  transactions    Transaction[]
}

model OrderOperationLog {
  id           String      @id @default(cuid())
  orderId      String
  operatorId   String
  operatorRole UserRole
  oldStatus    OrderStatus
  newStatus    OrderStatus
  remark       String?
  createdAt    DateTime    @default(now())
  order        Order       @relation(fields: [orderId], references: [id])
}

model OrderReview {
  id        String   @id @default(cuid())
  orderId   String   @unique
  rating    Int
  content   String?
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id])
}

model Banner {
  id        String   @id @default(cuid())
  imageUrl  String
  linkUrl   String?
  sortOrder Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("draft")
}

model CouponTemplate {
  id            String       @id @default(cuid())
  name          String
  amount        Decimal      @db.Decimal(18, 2)
  minSpend      Decimal      @db.Decimal(18, 2)
  totalQuantity Int
  validDays     Int
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  categoryIds   String[]
  description   String?
  userLimit     Int          @default(1)
  userCoupons   UserCoupon[]
}

model UserCoupon {
  id         String         @id @default(cuid())
  userId     String
  templateId String
  isUsed     Boolean        @default(false)
  usedAt     DateTime?
  expireAt   DateTime
  createdAt  DateTime       @default(now())
  template   CouponTemplate @relation(fields: [templateId], references: [id])
  user       User           @relation(fields: [userId], references: [id])
}

model Withdrawal {
  id               String           @id @default(cuid())
  providerId       String
  amount           Decimal          @db.Decimal(18, 2)
  status           WithdrawalStatus @default(PENDING)
  applyTime        DateTime         @default(now())
  bankInfo         String
  firstReviewerId  String?
  secondReviewerId String?
  reviewedAt       DateTime?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  transactions     Transaction[]
  provider         Provider         @relation(fields: [providerId], references: [id])
}

model Transaction {
  id            String          @id @default(cuid())
  type          TransactionType
  amount        Decimal         @db.Decimal(18, 2)
  beforeBalance Decimal         @db.Decimal(18, 2)
  afterBalance  Decimal         @db.Decimal(18, 2)
  userId        String?
  providerId    String?
  orderId       String?
  withdrawalId  String?
  createdAt     DateTime        @default(now())
  order         Order?          @relation(fields: [orderId], references: [id])
  provider      Provider?       @relation(fields: [providerId], references: [id])
  user          User?           @relation(fields: [userId], references: [id])
  withdrawal    Withdrawal?     @relation(fields: [withdrawalId], references: [id])
}

model ProviderSchedule {
  id         String   @id @default(cuid())
  providerId String
  date       DateTime
  slots      String[]
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id])
}

model AuditLog {
  id           String     @id @default(cuid())
  module       String
  action       String
  operatorId   String
  operatorRole UserRole
  entityId     String?
  detail       Json?
  createdAt    DateTime   @default(now())
  adminId      String?
  admin        AdminUser? @relation(fields: [adminId], references: [id])
}

model SpecialOffer {
  id            String   @id @default(cuid())
  name          String
  category      String
  price         Decimal  @db.Decimal(18, 2)
  unit          String
  rating        Decimal  @db.Decimal(3, 2)
  image         String
  description   String
  providerCount Int      @default(0)
  tags          String[]
  status        String   @default("active")
  sortOrder     Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model ServiceSpecification {
  id            String   @id @default(cuid())
  serviceId     String
  label         String
  description   String
  price         Decimal  @db.Decimal(18, 2)
  originalPrice Decimal? @db.Decimal(18, 2)
  duration      Int?
  sortOrder     Int      @default(1)
  status        String   @default("active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

model UserFavoriteProvider {
  id         String   @id @default(cuid())
  userId     String
  providerId String
  createdAt  DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, providerId])
}

model FlashSale {
  id            String   @id @default(cuid())
  serviceId     String
  specId        String?
  flashPrice    Decimal  @db.Decimal(18, 2)
  originalPrice Decimal  @db.Decimal(18, 2)
  totalStock    Int
  currentStock  Int
  startTime     DateTime
  endTime       DateTime
  status        String   @default("pending")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum ProviderStatus {
  UNVERIFIED
  PENDING
  VERIFIED
  REJECTED
}

enum ProviderType {
  MATERNITY_NURSE
  CHILD_CARE_NURSE
  LIVE_IN_NANNY
  CLEANING
  HOUSEKEEPING
  HOURLY_WORKER
  LAUNDRY_CARE
  HOSPITAL_CARE
  ELDERLY_CARE
  COOKING
  TUTORING
}

enum OrderStatus {
  PENDING_PAYMENT    // 待支付
  PENDING           // 待接单（已支付）
  ACCEPTED          // 已接单
  ARRIVED           // 已到达
  STARTED           // 服务中
  COMPLETED         // 已完成
  CANCELED          // 已取消
}

enum TransactionType {
  INCOME
  WITHDRAWAL
  REFUND
}

enum WithdrawalStatus {
  PENDING
  PENDING_REVIEW
  APPROVED
  REJECTED
}
